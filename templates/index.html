<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>CampusHub</title>
    <link rel="stylesheet" href="/static/style.css">

    <style>
        /* --- 3 欄布局 --- */
        .layout {
            display: flex;
            width: 100%;
            max-width: 1300px;
            margin: 30px auto;
            gap: 25px;
        }

        /* 左側分類欄 */
        .sidebar-left {
            width: 200px;
            background: white;
            border-radius: 10px;
            padding: 15px;
            height: fit-content;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .tag-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .tag-item {
            display: block;
            background: #f4f4f4;
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: 0.2s;
            font-size: 15px;
        }

        .tag-item:hover {
            background: #e0e0e0;
        }

        /* 點擊後高亮 */
        .tag-active {
            background: #5e35b1 !important;
            color: white !important;
        }

        /* 中間內容 */
        .main-content {
            flex: 1;
        }

        /* 右邊留白 */
        .sidebar-right {
            width: 200px;
        }

        .loading {
            text-align: center;
            margin-top: 20px;
            display: none;
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="logo">CampusHub</div>
        <ul>
            <li><a href="/home">首頁</a></li>

            {% if current_user.is_authenticated %}
                <li><a href="/posts/create">新增文章</a></li>
                <li><a href="/logout">登出（{{ current_user.username }}）</a></li>
            {% else %}
                <li><a href="/login">登入</a></li>
                <li><a href="/register">註冊</a></li>
            {% endif %}
        </ul>
    </nav>

    <header class="hero">
        <h1>歡迎來到 CampusHub</h1>
    </header>

    <div class="layout">

        <!--左側分類欄 -->
        <aside class="sidebar-left">
            <div class="tag-title">分類標籤</div>
            
            <a class="tag-item tag-active" onclick="filterTag('', this)">全部文章</a>
            <a class="tag-item" onclick="filterTag('Life', this)">Life</a>
            <a class="tag-item" onclick="filterTag('School', this)">School</a>
            <a class="tag-item" onclick="filterTag('Love', this)">Love</a>
            <a class="tag-item" onclick="filterTag('Emotion', this)">Emotion</a>
            <a class="tag-item" onclick="filterTag('Travel', this)">Travel</a>
            <a class="tag-item" onclick="filterTag('Food', this)">Food</a>
            <a class="tag-item" onclick="filterTag('Friends', this)">Friends</a>
            <a class="tag-item" onclick="filterTag('Career', this)">Career</a>
        </aside>

        <!-- 中間文章列表 -->
        <main class="main-content">
            <h2>最新文章</h2>

            <div id="post-container"></div>

            <div id="loading" class="loading">載入中...</div>
        </main>

        <!--右側留白 -->
        <aside class="sidebar-right"></aside>

    </div>

    <!-- 無限滾動 + 分類切換 JS -->
    <script>
        let page = 1;
        let loading = false;
        let currentTag = "";

        function loadPosts(reset = false) {
            if (loading) return;
            loading = true;

            document.getElementById("loading").style.display = "block";

            fetch(`/api/posts?page=${page}&tag=${currentTag}`)
                .then(res => res.json())
                .then(data => {
                    document.getElementById("loading").style.display = "none";

                    const container = document.getElementById("post-container");

                    if (reset) container.innerHTML = "";

                    data.posts.forEach(p => {
                        const div = document.createElement("div");
                        div.className = "post-card";

                        const tagHTML = p.tag
                            ? `<span class="tag-badge tag-${p.tag}">${p.tag}</span>`
                            : "";

                        div.innerHTML = `
                            ${tagHTML}
                            <h2><a href="/posts/${p.id}" style="color:#5e35b1; text-decoration:none;">${p.title}</a></h2>
                            <p style="font-size:14px; color:gray;">作者：${p.author}｜${p.created_at}</p>
                            <p style="margin-top:10px;">${p.content}</p>
                        `;

                        container.appendChild(div);
                    });

                    if (data.has_next) {
                        page++;
                        loading = false;   // ★ 必須重置，否則下一次不能載入
                    }
                });
        }

        // 切換分類
        function filterTag(tag, el) {
            currentTag = tag;
            page = 1;
            loading = false; // ★ 重置 loading，避免卡死

            // 更新左側高亮
            document.querySelectorAll(".tag-item").forEach(t => t.classList.remove("tag-active"));
            el.classList.add("tag-active");

            loadPosts(true);
        }

        // 初次載入
        loadPosts();

        // 無限捲動
        window.addEventListener("scroll", () => {
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 300) {
                loadPosts();
            }
        });
    </script>

</body>
</html>
