<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>CampusHub</title>
    <link rel="stylesheet" href="/static/style.css">

    <style>
        /* --- 3 æ¬„å¸ƒå±€ --- */
        .layout {
            display: flex;
            width: 100%;
            max-width: 1300px;
            margin: 30px auto;
            gap: 25px;
        }

        /* å·¦å´åˆ†é¡æ¬„ */
        .sidebar-left {
            width: 200px;
            background: white;
            border-radius: 10px;
            padding: 15px;
            height: fit-content;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .tag-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .tag-item {
            display: block;
            background: #f4f4f4;
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: 0.2s;
            font-size: 15px;
        }

        .tag-item:hover {
            background: #e0e0e0;
        }

        /* é»æ“Šå¾Œé«˜äº® */
        .tag-active {
            background: #5e35b1 !important;
            color: white !important;
        }

        /* ä¸­é–“å…§å®¹ */
        .main-content {
            flex: 1;
        }

        /* å³é‚Šç•™ç™½ */
        .sidebar-right {
            width: 200px;
        }

        .loading {
            text-align: center;
            margin-top: 20px;
            display: none;
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="navbar-container">

            <!-- å·¦ï¼šLogo -->
            <div class="logo">CampusHub</div>

            <!-- ä¸­ï¼šæœå°‹æ¡† -->
            <div class="navbar-center">
                <input id="searchBox"
                    type="text"
                    placeholder="æœå°‹æ–‡ç« ..."
                    onkeyup="searchPosts()"
                    class="search-input">
            </div>

            <!-- å³ï¼šé¸å–® -->
            <ul class="navbar-menu">
                <li><a href="/home">é¦–é </a></li>

                {% if current_user.is_authenticated %}
                    <li><a href="/posts/create">æ–°å¢æ–‡ç« </a></li>
                    <li><a href="/logout">ç™»å‡ºï¼ˆ{{ current_user.username }}ï¼‰</a></li>
                {% else %}
                    <li><a href="/login">ç™»å…¥</a></li>
                    <li><a href="/register">è¨»å†Š</a></li>
                {% endif %}
            </ul>

        </div>
    </nav>

    <header class="hero">
        <h1>æ­¡è¿ä¾†åˆ° CampusHub</h1>
    </header>

    <div class="layout">

        <!--å·¦å´åˆ†é¡æ¬„ -->
        <aside class="sidebar-left">
            <div class="tag-title">åˆ†é¡æ¨™ç±¤</div>
            
            <a class="tag-item tag-active" onclick="filterTag('', this)">å…¨éƒ¨æ–‡ç« </a>
            <a class="tag-item" onclick="filterTag('Life', this)">Life</a>
            <a class="tag-item" onclick="filterTag('School', this)">School</a>
            <a class="tag-item" onclick="filterTag('Love', this)">Love</a>
            <a class="tag-item" onclick="filterTag('Emotion', this)">Emotion</a>
            <a class="tag-item" onclick="filterTag('Travel', this)">Travel</a>
            <a class="tag-item" onclick="filterTag('Food', this)">Food</a>
            <a class="tag-item" onclick="filterTag('Friends', this)">Friends</a>
            <a class="tag-item" onclick="filterTag('Career', this)">Career</a>
        </aside>

        <!-- ä¸­é–“æ–‡ç« åˆ—è¡¨ -->
        <main class="main-content">
            <h2>æœ€æ–°æ–‡ç« </h2>

            <div id="post-container"></div>

            <div id="loading" class="loading">è¼‰å…¥ä¸­...</div>
        </main>

        <!--å³å´ç•™ç™½ -->
        <aside class="sidebar-right"></aside>

    </div>

    <!-- ç„¡é™æ»¾å‹• + åˆ†é¡åˆ‡æ› JS -->
    <script>
let page = 1;
let loading = false;
let currentTag = "";

function renderPost(p) {
    const div = document.createElement("div");
    div.className = "post-card";

    const tagHTML = p.tag
        ? `<span class="tag-badge tag-${p.tag}">${p.tag}</span>`
        : "";

    div.innerHTML = `
        <h2>
            <a href="/posts/${p.id}" style="color:#5e35b1; text-decoration:none;">
                ${p.title}
            </a>
        </h2>

        <p style="font-size:14px; color:gray;">
            ä½œè€…ï¼š${p.author}ï½œ${p.created_at}
        </p>

        <p style="font-size:14px; margin-bottom:6px;">
            ğŸ’¬ ç•™è¨€ï¼š${p.comment_count}
            &nbsp;ï½œ&nbsp;
            ğŸ‘ <span id="like-count-${p.id}">${p.like_count}</span>
            <button onclick="toggleLike(${p.id})"
                    style="border:none; background:none; cursor:pointer;">
                æŒ‰è®š
            </button>
        </p>

        ${tagHTML}

        <p style="margin-top:10px;">${p.content}</p>
    `;

    return div;
}

function loadPosts(reset = false) {
    if (loading) return;
    loading = true;

    document.getElementById("loading").style.display = "block";

    fetch(`/api/posts?page=${page}&tag=${currentTag}`)
        .then(res => res.json())
        .then(data => {
            document.getElementById("loading").style.display = "none";

            const container = document.getElementById("post-container");
            if (reset) container.innerHTML = "";

            data.posts.forEach(p => {
                container.appendChild(renderPost(p));
            });

            if (data.has_next) {
                page++;
                loading = false;
            }
        });
}

// åˆ‡æ›åˆ†é¡
function filterTag(tag, el) {
    currentTag = tag;
    page = 1;
    loading = false;

    document.querySelectorAll(".tag-item")
        .forEach(t => t.classList.remove("tag-active"));
    el.classList.add("tag-active");

    loadPosts(true);
}

// æœå°‹
function searchPosts() {
    const q = document.getElementById("searchBox").value.trim();

    // æœå°‹æ™‚å¼·åˆ¶å›åˆ°å…¨éƒ¨æ–‡ç« 
    currentTag = "";
    page = 1;

    document.querySelectorAll(".tag-item")
        .forEach(t => t.classList.remove("tag-active"));
    document.querySelector(".tag-item").classList.add("tag-active");

    if (q === "") {
        loadPosts(true);
        return;
    }

    fetch(`/api/search?q=${q}`)
        .then(res => res.json())
        .then(data => {
            const container = document.getElementById("post-container");
            container.innerHTML = "";
            data.posts.forEach(p => {
                container.appendChild(renderPost(p));
            });
        });
}

// æŒ‰è®š
function toggleLike(postId) {
    fetch(`/api/posts/${postId}/like`, {
        method: "POST"
    })
    .then(res => {
        if (res.status === 401) {
            alert("è«‹å…ˆç™»å…¥æ‰èƒ½æŒ‰è®š");
            throw new Error();
        }
        return res.json();
    })
    .then(data => {
        document.getElementById(`like-count-${postId}`).innerText =
            data.like_count;
    });
}

// åˆæ¬¡è¼‰å…¥
loadPosts();

// ç„¡é™æ²å‹•
window.addEventListener("scroll", () => {
    if ((window.innerHeight + window.scrollY) >=
        document.body.offsetHeight - 300) {
        loadPosts();
    }
});
</script>


</body>
</html>
